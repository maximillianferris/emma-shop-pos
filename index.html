<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Emma's Shop POS</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    .line-item { display: flex; gap: 1em; margin-bottom: 0.5em; }
    input[type="number"] { width: 6em; }
    select { min-width: 200px; }
    #total { font-weight: bold; margin-top: 1em; }
  </style>
</head>
<body>
  <h1>Emma's Shop POS</h1>
  <form id="posForm">
    <div id="lineItems"></div>
    <div id="total">Total: £0.00</div>
    <button type="submit">Submit Sale</button>
  </form>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbz-MhfHda6GudQvkxcxyYDucM07FU5NdCxlcD0nJO7SwISBZrK46zSvfYE0L8xGccuv/exec'; // Replace with your deployed Apps Script Web App URL
    let products = [];

    async function loadProducts() {
      try {
        const res = await fetch(API_URL + '?action=getInventory');
        const data = await res.json();
        console.log(data);  // Add this to verify the structure
        products = data;
        if (products.length > 0) {
          addLineItem();  // Add the first line item if products are loaded
        } else {
          alert("No products found in inventory!");
        }
      } catch (error) {
        console.error('Error loading products:', error);
        alert('Error loading products. Please try again.');
      }
    }

    function addLineItem() {
      const line = document.createElement('div');
      line.className = 'line-item';

      const productSelect = document.createElement('select');
      productSelect.innerHTML = `<option value="">Select product</option>` + 
        products.map(p => {
          console.log(`Product: ${p.product}, Price per g: ${p['priceperg']}`);  // Log prices
          return `<option value="${p.product}" data-price="${p['priceperg']}">${p.product}</option>`;
        }).join('');
      
      const qtyInput = document.createElement('input');
      qtyInput.type = 'number';
      qtyInput.min = 0;
      qtyInput.step = 0.01;
      qtyInput.placeholder = 'Qty (g)';

      const subtotalDisplay = document.createElement('span');
      subtotalDisplay.textContent = '£0.00';

      productSelect.addEventListener('change', () => {
        console.log(productSelect.selectedOptions[0]?.dataset.price);  // Log price to check
        updateSubtotal();
      });
      qtyInput.addEventListener('input', () => {
        console.log('Quantity changed');
        updateSubtotal();
      });
      
      function updateSubtotal() {
        const price = productSelect.selectedOptions.length > 0 ? parseFloat(productSelect.selectedOptions[0].dataset.price || 0) : 0;
        const qty = qtyInput.value ? parseFloat(qtyInput.value) : 0;


      
        if (isNaN(price) || isNaN(qty)) {
          subtotalDisplay.textContent = '£0.00';
          return;
        }
      
        const subtotal = price * qty;
        subtotalDisplay.textContent = `£${subtotal.toFixed(2)}`;
        updateTotal();  // Update the overall total after each line item change
      }



      function updateTotal() {
        const allLines = document.querySelectorAll('.line-item');
        let total = 0;
        allLines.forEach(l => {
          const sel = l.querySelector('select');
          const inp = l.querySelector('input');
          const price = parseFloat(sel.selectedOptions[0]?.dataset.price || 0);
          const qty = parseFloat(inp.value) || 0;
          total += price * qty;
        });
        console.log('Updated total:', total);  // Log total for debugging
        document.getElementById('total').textContent = `Total: £${total.toFixed(2)}`;
      }


      qtyInput.addEventListener('blur', () => {
        if (productSelect.value && qtyInput.value) addLineItem();
      });

      line.append(productSelect, qtyInput, subtotalDisplay);
      document.getElementById('lineItems').appendChild(line);
    }

    document.getElementById('posForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const entries = [];
      document.querySelectorAll('.line-item').forEach(line => {
        const sel = line.querySelector('select');
        const inp = line.querySelector('input');
        const price = parseFloat(sel.selectedOptions[0]?.dataset.price || 0);
        const qty = parseFloat(inp.value) || 0;
        if (sel.value && qty > 0) {
          entries.push({
            product: sel.value,
            quantity: qty,
            subtotal: +(price * qty).toFixed(2)
          });
        }
      });

      if (!entries.length) return alert('Please add at least one product.');

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'submitSale', entries })
        });
        const msg = await res.text();
        alert(msg);
        location.reload();
      } catch (error) {
        console.error('Error submitting sale:', error);
        alert('Error submitting sale. Please try again.');
      }
    });

    loadProducts();
  </script>
</body>
</html>
